defaults:
    image: &image
        docker:
            - image: circleci/node:11.6.0
    yarn_cache: &yarn_cache
        key: yarn_cache-v{{ .Environment.CACHE_VERSION }}-{{ .Branch }}-{{ checksum "yarn.lock" }}
    yarn_install: &yarn_install
        name: Install
        command: yarn
    setup_git: &setup_git
        name: Setup Git user
        command: |
            git config --global user.email "ops@groupbyinc.com"
            git config --global user.name "GroupBy Ops"
            git config --global push.default simple
            # cp .circleci/prepare-commit-msg .git/hooks/prepare-commit-msg
            # chmod +x .git/hooks/prepare-commit-msg
    persist_repo: &persist_repo
        root: ~/
        paths:
            - project

version: 2

jobs:
    build:
        <<: *image
        steps:
            - checkout
            - attach_workspace:
                at: ~/
            - restore_cache: *yarn_cache
            - run: *yarn_install
            - save_cache:
                <<: *yarn_cache
                paths:
                    - ~/.cache/yarn
            - run:
                name: Build
                command: yarn build
            - persist_to_workspace: *persist_repo

    unit_test:
        <<: *image
        steps:
            - run: npm run test+coverage

    publish:
        <<: *image
        # tag: /v[0-9]+(\.[0-9]+)*/
        # owner: groupby
        steps:
        # npm:
            - attach_workspace:
                at: ~/
            - run: echo "//registry.npmjs.org/:_authToken=${NPM_API_KEY}" > ~/.npmrc
            - run: npm run build
            - run: npm publish

workflows:
    version: 2

    build_test:
        jobs:
            - build
            - unit_test:
                requires:
                    - build
